---
title: "Logistic Regression Tutorial"
author: "Nick Broussard"
date: "9/11/2019"
output: 
  html_document:
    code_folding: hide
  
---

```{r setup, include=FALSE}

library(tidyverse)
library(inspectdf) #inspect_na(), inspect_num()
library(kableExtra)
library(summarytools)
library(scales) #percent
library(data.table)
library(jtools) #summ(), export_summs()
library(interactions) #cat_plot(), interact_plot()

knitr::opts_chunk$set(echo = F, 
                      warning = F, 
                      message = F, 
                      error = F,
                      results = "asis",
                      comment = NA,
                      prompt = F,
                      print = "render")

st_options(bootstrap.css     = FALSE,       
           plain.ascii       = FALSE,       
           style             = "rmarkdown", 
           dfSummary.silent  = TRUE,        
           footnote          = NA,          
           subtitle.emphasis = FALSE)       
```

```{r, echo = FALSE, include=F}
st_css()
```

A topic I find super interesting is municipal action against AirBNB, VRBO, and other (so designated) short term rental companies. In Austin, residents are supposed to registered with the City before gigging out their rooms/homes. There's virtually no incentive to register with the City, however, because the City doesn't enforce compliance. As with most government regulations, compliance is regulated through resident complaints. They have no other way of knowing if I'm doing AirBNB unless my neighbor submits some kind of complaint. City's generally (1) are understaffed, and (2) don't know how to use technology (like getting on airbnb.com and searching for homes, then comparing listings against registrations). Even without any real enforcement arm, lot's of people get turned in. To explore complaint-based enforcement, I want to use the City of Austin's ["Short Term Rental Legal Outcomes"](https://data.austintexas.gov/City-Government/Short-Term-Rental-Legal-Outcomes/xfmy-m22z) data set. Between 2018 and 2019, there are 3,472 cases listed, in which many are cited for not registering their homes before gigging.

I'm asking if the likeliood of a conviction, given a legal charge, is affected by the type of charge, the fee associated with the charge, and the months the violation is open before the final judicial decision.

## Explore and Clean

First, read in the df.

```{r}
df <- fread("https://raw.githubusercontent.com/nicholasbroussard/tutorials/master/logistic.binomial_rentals_austin.csv")
#https://data.austintexas.gov/City-Government/Short-Term-Rental-Legal-Outcomes/xfmy-m22z
```

Second, select variables.

```{r}
df <- df %>%
  select(-CASENUMBER, -CITATIONTYPE, -CITATIONNUMBER, -DEFICIENCYCODE, -FEEAMOUNT)
```

Third, look at the df's structure...

```{r}
glimpse(df)
```
...and convert variables accordingly.

```{r}
library(lubridate)
df$VIOLATIONOPENDATE <- mdy_hms(df$VIOLATIONOPENDATE)
df$LEGALOUTCOMEDATE <- mdy_hms(df$LEGALOUTCOMEDATE)
#Find the number of months it takes between opening a violation and legally closing it.
df <- df %>% 
  mutate(MONTHSVIOLATIONOPEN = interval(VIOLATIONOPENDATE, LEGALOUTCOMEDATE)%/%months(1)) %>%
  select(-VIOLATIONOPENDATE, -LEGALOUTCOMEDATE)

#Consolidate types of deficiencies.
df$DEFICIENCYTEXT <- as.character(df$DEFICIENCYTEXT)
df <- df %>%
  mutate(DEFICIENCYTEXT = case_when(str_detect(DEFICIENCYTEXT, "must obtain a license") | str_detect(DEFICIENCYTEXT, "is not licensed") ~ "Licensing Violation",
                                    str_detect(DEFICIENCYTEXT, "may not advertise or promote") ~ "Incomplete Registration Violation",
                                    str_detect(DEFICIENCYTEXT, "may not be used by more than") | str_detect(DEFICIENCYTEXT, "may not include the rental of less than") | str_detect(DEFICIENCYTEXT, "16 people") ~ "Occupancy Limit Violation",
                                    str_detect(DEFICIENCYTEXT, "The advertisement required a three night minimum stay") ~ "Length of Stay Violation"))

#Build binary outcome variable.
df <- df %>%
  mutate(LEGALOUTCOME = ifelse(LEGALOUTCOME=="Liable" | LEGALOUTCOME=="Closed due to Judicial / Admin Action", 0, 1))
#0 is "not penalized", 1 is penalized. I have to code the outcome var as 0/1 for the glm().

df <- df %>%
  select(LEGALOUTCOME, DEFICIENCYTEXT, OUTSTANDINGFEE, MONTHSVIOLATIONOPEN)
```

Fourth, inspect the categoricals.

```{r}
df %>%
  inspectdf::inspect_cat() %>%
  show_plot()
```

Based on distributions, restrict if appropriate.

```{r}
a <- ggplot(df, aes(x = DEFICIENCYTEXT)) +
  geom_bar(color = "midnightblue", fill = "cadetblue", alpha = .7) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

b <- ggplot(df, aes(LEGALOUTCOME)) +
  geom_bar(color = "midnightblue", fill = "cadetblue", alpha = .7) 

gridExtra::grid.arrange(a,b, ncol = 2)

df <- df %>%
  filter(DEFICIENCYTEXT != "Length of Stay Violation")
```

Fifth, inspect numerics by calling the 5-number-summary...

```{r numerics}
df %>%
  summarytools::descr(transpose = T,
        stats = "fivenum") %>%
  print(headings = F,
        method = "render")
```

...and histogram distributions...

```{r}
a <- ggplot(df, aes(MONTHSVIOLATIONOPEN)) +
  geom_histogram(color = "midnightblue", fill = "cadetblue", alpha = .7, bins = 30) 

b <- ggplot(df, aes(OUTSTANDINGFEE)) +
  geom_bar(color = "midnightblue", fill = "cadetblue", alpha = .7, bins = 30) 

gridExtra::grid.arrange(a,b, ncol = 2)

df$OUTSTANDINGFEE[df$OUTSTANDINGFEE<=0] <- NA
```

...and for outliers.

```{r}
par(mfrow=c(1,2))
monthsopen_outliers <- boxplot(df$MONTHSVIOLATIONOPEN)$out
fee_outliers <- boxplot(df$OUTSTANDINGFEE)$out
```

Sixth, check missingness...

```{r}
df %>%
  inspectdf::inspect_na() %>%
  show_plot()
```

and impute...

```{r}
library(mice)
set.seed(101)
imp <- mice(df, m = 1, maxit = 1, print = F)
df <- complete(imp)
df$OUTSTANDINGFEE <- as.numeric(df$OUTSTANDINGFEE)
```

Seventh, and last, check correlation. 

```{r}
df %>%
  GGally::ggcorr(label = TRUE, 
         label_alpha = TRUE,
         hjust=.9,
         size=3.5,
         layout.exp=3,
         method = c("pairwise.complete.obs", "spearman")) +
  labs(title="Correlation Matrix")
```

The threshold for multicolinearity of .7 is achieved only between reponse and predictor variables. No issue.


## Model 

Split.

```{r}
library(caTools)
set.seed(101) #The seed number does not matter. Any number will do.
sample <- sample.split(df, SplitRatio = .6)
test <- subset(df, sample == TRUE)
train <- subset(df, sample == FALSE)
```

Build and interpret the model.

```{r}
set.seed(101)
model <- glm(LEGALOUTCOME ~ ., data = train, family = binomial(link="logit")) 
summ(model, exp = T, vifs = T, digits = 4)
```

Model: $\ y=907+1.67*LicensingViolation+10.98*OccupancyViolation+0.98*OutstandingFee+0.81*MonthsOpen$

For the outcome variable, 0 is not penalized and 1 is penalized.
Reference category for DEFICIENCYTEXT is RegistrationViolation.

Interpretation:
* A licensing violation is 66% more likely to result in a penalty than an incomplete registration violation controlling for all other variables. Not staistically significant.
* An occupancy limit violation is 11x (1,098%) more likely to result in a penalty than an incomplete registration violation.
* For every $1 increase in outstanding fee the likelihood of penalty decreases by 1% (1-.989).
* For every month that the violation is open the likelhood of penalty decreases by 19% (1-.81).


Third, conduct graphical analysis. Analyze coefficients...

```{r}
plot_summs(model, plot.distributions = TRUE, exp = T)
```

..and look at the relationship between predictors and the outcome.

```{r}
a <- effect_plot(model, pred = DEFICIENCYTEXT, interval = T, cat.geom = "line")
b <- effect_plot(model, pred = OUTSTANDINGFEE, interval = T, rug = T)
c <- effect_plot(model, pred = MONTHSVIOLATIONOPEN, interval = T, rug = T)

gridExtra::grid.arrange(a,b,c, ncol = 2)

```

Fourth, pull in fitted and residual values...

```{r}
train$fitted <- model$fitted.values
train$residuals <- model$residuals
```

...and query the model.

* What are the odds of penalty for cases open two months? `r train %>% filter(MONTHSVIOLATIONOPEN == 2) %>% summarise(percent(mean(fitted)))`
* What are the odds of penalty for any given licensing violation? `r train %>% filter(DEFICIENCYTEXT=="Licensing Violation") %>% summarise(percent(mean(fitted)))`

Fifth, evaluate goodness of fit. Start with running an ANOVA...

```{r}
library(stats)
anova <- anova(model, test = "Chisq")
anova
```

Null Deviance: `r model$null.deviance `
Residual Deviance: `r anova$"Resid. Dev" `
AIC: `r summary(model)$aic`

...then run an ROC curve and a confusion matrix.

```{r}
library(ROCR)
ROCRpred <- prediction(train$fitted, train$LEGALOUTCOME)
ROCRperf <- performance(ROCRpred, "tpr", "fpr")
plot(ROCRperf, colorize = T) #ROC Curve
table(train$LEGALOUTCOME, train$fitted > 0.5) #confusion matrix
```

Sixth, and last, run a new set of predicted values from the test set, then run another confusion matrix and compare. 

```{r}
test$fitted <- predict(model, newdata = test, type = "response")
table(test$LEGALOUTCOME, test$fitted > .5)
```


## Compare

Build another model with fewer predictors.

```{r}
set.seed(101)
model2 <- glm(LEGALOUTCOME ~ OUTSTANDINGFEE + MONTHSVIOLATIONOPEN, data = train, family = binomial(link = "logit"))
summ(model2, exp = T, digits = 4, vifs = T)
```

Compare as a side-by-side table...

```{r}
export_summs(model, model2, 
             scale = T, 
             error_format = "[{conf.low},{conf.high}]") #Include confidence intervals for each variable.
```

... and graphically by coefficients.

```{r}
plot_summs(model, model2, exp = T, partial.distributions = T)
```

## Sources
* https://datascienceplus.com/perform-logistic-regression-in-r/
* https://www.datacamp.com/community/tutorials/logistic-regression-R
* https://towardsdatascience.com/simply-explained-logistic-regression-with-example-in-r-b919acb1d6b3
* https://www.theanalysisfactor.com/r-glm-model-fit/
* http://r-statistics.co/Logistic-Regression-With-R.html
* https://webfocusinfocenter.informationbuilders.com/wfappent/TLs/TL_rstat/source/LogisticRegression43.htm
* AIC and Model Parsimony: https://www.r-bloggers.com/how-do-i-interpret-the-aic/
* https://www.analyticsvidhya.com/blog/2015/11/beginners-guide-on-logistic-regression-in-r/
* effect_plot in jtools: https://cran.r-project.org/web/packages/jtools/vignettes/effect_plot.html 
* Beginner's Guide to Logistic Regression: https://www.analyticsvidhya.com/blog/2015/11/beginners-guide-on-logistic-regression-in-r/






